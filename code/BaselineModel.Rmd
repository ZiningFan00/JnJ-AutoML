---
title: "baselineModel"
output: html_document
---
```{r}
library(ggplot2)
library(tidyverse)
library(stringr)
library(GGally)
library(parcoords)
library(tidyr)
library(r2d3)
library(dplyr)
library(readr)
library(gridExtra)
library(plotly)
```


```{r}
#install.packages('RJDBC')

## --------------------------------
## Sets Java Home
## --------------------------------
if (Sys.getenv("JAVA_HOME")!="")  Sys.setenv(JAVA_HOME="")


## --------------------------------
## Loads libraries
## --------------------------------
library(rJava)
options(java.parameters = "-Xmx8048m")
library(RJDBC)
library(DBI)


## --------------------------------
## Sets Java Home
## --------------------------------
if (Sys.getenv("JAVA_HOME")!="")
  Sys.setenv(JAVA_HOME="")


## --------------------------------
## Loads libraries
## --------------------------------
library(rJava)
options(java.parameters = "-Xmx8048m")
library(RJDBC)
library(DBI)


## --------------------------------
## General Variables
## --------------------------------
redShiftDriver <- JDBC("com.amazon.redshift.jdbc41.Driver", "RedshiftJDBC41-1.2.8.1005.jar", identifier.quote="`")
# put Redshift jar file in your home directory
resultSet <- data.frame()
username <- "zfan4"               ## Set VPCx / Redshift username - this is your J&J userID, for example mine is stong2  
password <- "19A3#a39F7py"            ## Set VPCx / Redshift password - this is the password you got from an encrypted email
rhealthDBName <- "saf"                ## Set dataset you want to connect to (full list provided here:  https://jnj.sharepoint.com/sites/PHM-GCSP-RND/RWE/Pages/rHEALTH-Database-Connectivity.aspx)


## --------------------------------
## Connection (do not change)
## --------------------------------
connectionString <- paste("jdbc:redshift://rhealth-prod-4.cldcoxyrkflo.us-east-1.redshift.amazonaws.com:5439/", rhealthDBName,"?ssl=true&sslfactory=com.amazon.redshift.ssl.NonValidatingFactory", sep="")
conn <- dbConnect(redShiftDriver, connectionString, username, password)


# dbListTables(conn)

res <- dbSendQuery(conn,'select * from saf.scratch_ctsaf2.np_col_hipfx_ads_v9') ## CTSAF2 is my scratch space
data <- fetch(res,n = -1) 

```

```{r}
df_medicare <- data
dim(df_medicare)
```

Remove target information
```{r}
columns_having_target_info <- c('mortality_365', 'readm_flag_365', 'er_365days', 're_claim_no',  're_clm_admsn_dt', 're_nch_bene_dschrg_dt','re_prvdr_num', 're_clm_utlztn_day_cnt', 're_clm_pmt_amt', 're_pdx', 're_ppx', 're_adm_source', 're_disc_status', 're_pdx_desc', 're_ppx_desc', 're_clm_admsn_dt_365', 're_nch_bene_dschrg_dt_365', 're_prvdr_num_365', 're_clm_utlztn_day_cnt_365', 're_clm_pmt_amt_365', 're_pdx_365', 're_ppx_365', 're_adm_source_365', 're_claim_no_365', 're_disc_status_365', 're_pdx_desc_365', 're_ppx_desc_365', 're_claim_no_365_up', 'readm_flag_365_up', 're_clm_admsn_dt_365_up', 're_nch_bene_dschrg_dt_365_up', 're_prvdr_num_365_up', 're_clm_utlztn_day_cnt_365_up', 're_clm_pmt_amt_365_up', 're_pdx_365_up', 're_ppx_365_up', 're_adm_source_365_up', 're_disc_status_365_up', 're_pdx_desc_365_up', 're_ppx_desc_365_up', 'er_claim_no_365', 'er_rev_cntr_dt_365', 'er_clm_thru_dt_365', 'er_prncpal_dgns_cd_365', 'er_pdx_desc_365', 'er_hcpcs_cd_365', 'er_hcpcs_desc_365', 'mortality_365_up', 'er_365days_up', 'er_claim_no_365_up', 'er_rev_cntr_dt_365_up', 'er_clm_thru_dt_365_up', 'er_prncpal_dgns_cd_365_up', 'er_pdx_desc_365_up', 'er_hcpcs_cd_365_up', 'er_hcpcs_desc_365_up'
)
df_medicare <- df_medicare[, !(colnames(df_medicare) %in% columns_having_target_info)]
```

Remove collinear features
```{r}
columns_having_collinearity <- c('cci_score_1825_days_b','elix_score_1825_days_b',  'fci_score_1825_days_b', 'follow_up_end_dt', 'follow_up_end_dt_365','ppx_desc', 'pdx_desc')

df_medicare <- df_medicare[, !(colnames(df_medicare) %in% columns_having_collinearity)]
```

Remove features same entry and unique entry
```{r}
columns_no_variance <- c('version_id', 'cont_enroll_flag_1825b_89f', 'valid_date_of_death_1825b_89f', 'hmo_enroll_flag_1825b_89f', 'hmo_enroll_flag_365f','cont_enroll_flag_365f','at_physn_upin', 'op_physn_upin', 'ot_physn_upin')

columns_unique <- c('desy_sort_key', 'claim_no', 'ot_physn_npi','at_physn_npi','op_physn_npi')

df_medicare <- df_medicare[, !(colnames(df_medicare) %in% columns_no_variance)]

df_medicare <- df_medicare[, !(colnames(df_medicare) %in% columns_unique)]
```

Remove missing value
```{r}
df_medicare <- df_medicare[,df_medicare %>% is.na() %>% colSums() == 0]
```

Remove columns leaking hospital information
```{r}

columns_hospital_info <- c('fci_arthritis_1825_days_b', 'fci_osteoporosis_1825_days_b', 'fci_asthma_1825_days_b', 'fci_copd_1825_days_b', 'fci_angina_1825_days_b', 'fci_cong_heart_fail_1825_days_b', 'fci_heart_attack_1825_days_b', 'fci_neur_dis_1825_days_b', 'fci_stroke_1825_days_b', 'fci_diabetes_1825_days_b', 'fci_perif_vasc_dis_1825_days_b', 'fci_upper_gi_1825_days_b', 'fci_depression_1825_days_b', 'fci_anxiety_panic_1825_days_b', 'fci_visual_imp_1825_days_b', 'fci_hear_imp_1825_days_b', 'fci_ddd_1825_days_b', 'fci_obesity_1825_days_b', 
'prvdr_state_cd', 'prov_vol_annual', 'prov_vol_per_month', 'prvdr_home_hha_vol', 'prvdr_home_hha_vol_month', 'prvdr_home_hha_vol_per', 'phy_vol_annual', 'phy_vol_month', 'op_phy_cum_exp', 'provider_type', 'hospital_name', 'prvdr_ssa_county_code', 'prvdr_urgeo', 'prvdr_urspa', 'prvdr_wi', 'prvdr_cola', 'prvdr_resident_to_bed_ratio', 'prvdr_rday', 'prvdr_beds', 'prvdr_dshpct', 'prvdr_dshopg', 'prvdr_dshcpg', 'prvdr_state_name', 'prvdr_state_ab', 'prvdr_div_code', 'prvdr_division', 'prvdr_region_cd', 'prvdr_region','county', 'bpci_lejr', 'cjr', 'bpci_ami_cabg', 'ami_cabg', 'prvdr_cbsa', 'prvdr_cbsa_desc', 'prvdr_msa', 'prvdr_msa_desc', 'prvdr_teaching_status', 'low_income_subsidy', 'prior_inp_only_los', 'prior_irf_los', 'prior_ltcf_los', 'prior_snf_los', 'prior_hha_visits', 'prior_out_visits', 'total_prior_los', 'poverty_per', 'grp_1', 'grp_2', 'grp_3', 'grp_4', 'grp_5', 'grp_6', 'grp_7', 'grp_8', 'grp_9', 'grp_10', 'unemp_percentage', 'no_of_snfs', 'ma_pen_percent', 'snf_per_capita')


df_medicare <- df_medicare[, !(colnames(df_medicare) %in% columns_hospital_info)]


```

```{r}
###df_medicare_state <- df_medicare %>% group_by(prvdr_state_name) %>% summarise(number = length(prvdr_state_name), sample = as.integer(length(prvdr_state_name)/10) )
## for histogram (entire dataset)

# ----------------- 
#Population Sampling
# -----------------

population_sample <- df_medicare %>% group_by(prvdr_state_name) %>% sample_n(as.integer(ceiling(length(prvdr_state_name)/20)))
```
Plot the distribution of each state
```{r,fig.height=6.5}

# to obtain summary based on provider's state
df_medicare_state <- df_medicare %>% group_by(prvdr_state_name) %>% summarise(number = length(prvdr_state_name),type = "population" )

test_state <- population_sample %>% group_by(prvdr_state_name) %>% summarise(number =  length(prvdr_state_name),type = "sample" )

df_medicare_state <- rbind(df_medicare_state,test_state)

ggplot(data=df_medicare_state, aes(x = reorder(prvdr_state_name,number), y=log(number)))+
  geom_bar(stat="identity",fill = "steelblue") +
  coord_flip() +
  xlab('state')+ 
  ylab('number of patients(log)') +
  facet_wrap(~ type) + 
  theme_minimal()
```
plot for different hospital
```{r}

df_medicare_hos <- df_medicare %>% group_by(provider_type) %>% summarise(number = length(provider_type), type = "population" )

test_hos <- population_sample %>% group_by(provider_type) %>% summarise(number =  length(provider_type),type = "sample" )

df_medicare_hos <- rbind(df_medicare_hos,test_hos)

ggplot(data=df_medicare_hos, aes(x = reorder(provider_type, number), y=log(number))) +
  geom_bar(stat="identity", fill="steelblue") +
  geom_text(aes(label=number), vjust=2, color="black",
            position = position_dodge(0.9), size=4)+
  coord_flip() +
  xlab('Hospital type')+ 
  ylab('number of patients(log)') +
  theme_minimal() +
  facet_wrap( ~ type)
```

```{r}
# ----------------- 
# train population model
# -----------------

# we focus on readmission now. so we remove mortality and er_90days 
drops<- c('mortality_90', 'er_90days')
population_sample <- population_sample[,!(colnames(population_sample) %in% drops)]

# Add time related features
population_sample$clm_admsn_dt = as.Date(population_sample$clm_admsn_dt)
population_sample$nch_bene_dschrg_dt = as.Date(population_sample$nch_bene_dschrg_dt)
population_sample$month = months(population_sample$clm_admsn_dt,abbreviate = TRUE)
population_sample$week_of_dates = weekdays(population_sample$clm_admsn_dt,abbreviate = TRUE)
population_sample$days_before_admsn = population_sample$clm_admsn_dt-as.Date('2016-01-01')
population_sample$days_before_dschrg = population_sample$nch_bene_dschrg_dt - as.Date('2016-01-01')

# hold out test set
population_sample = population_sample[order(population_sample$clm_admsn_dt),]
size = nrow(population_sample)
train_valid_size = as.integer(round(size*0.8,digits=0))
test_size = as.integer(size - train_valid_size)
train_valid = population_sample[c(1:train_valid_size), ]
test = population_sample[c((train_valid_size+1):size), ]

# dataset for base model (remove time related features)
drops = c('clm_admsn_dt','nch_bene_dschrg_dt','month','week_of_dates','days_before_admsn','days_before_dschrg')
train_valid_base = train_valid[,!(colnames(train_valid) %in% drops)]
test_base = test[,!(colnames(test) %in% drops)]

library(caret)
train_valid_base$readm_flag=as.factor(train_valid_base$readm_flag)
train_valid_base[sapply(train_valid_base, is.character)] <- lapply(train_valid_base[sapply(train_valid_base, is.character)], 
                                       as.factor)

logistic = train(
  form = readm_flag ~ .,
  data = train_valid_base,
  trControl = trainControl(method = "cv", number = 5),
  method = 'regLogistic'
)
```

```{r}
temp=train_valid_base[c(101:102),c(1:6,8:10)]
reglogistic_prediction <- predict(logistic,
                                    newdata = temp, type = "prob")
```

```{r}
#testing
df_medicare_hostype <- df_medicare %>% group_by(provider_type) %>% summarise(number = length(provider_type), sample = as.integer(length(provider_type)/5) )

df_medicare__population_hostype <- population_sample %>% group_by(provider_type) %>% summarise(number = length(provider_type))
```